---
title: "Active Model Serializer ã§å­«è¦ç´ ã‚’å«ã‚€å ´åˆã®ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rails"]
published: false
publication_name: "socialplus"
---
## ã¯ã˜ã‚ã«
å¼Šç¤¾ã§ã¯ JSON ã‚’è¿”å´ã™ã‚‹ API ã‚’é–‹ç™ºã™ã‚‹éš›ã«ã€Active Model Serializer ã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã„ã¾ã™ã€‚
https://github.com/rails-api/active_model_serializers

æ™®æ®µã® API ã®é–‹ç™ºã§ã¯å…ˆã« Serializer ã¨ãã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã€ãã®å¾Œã« Controller ã¨ãã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

ä»Šå›ã¯ä¾‹ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªå­«è¦ç´ ï¼ˆ`comments`ï¼‰ã‚’å«ã‚€ JSON ã‚’è¿”å´ã™ã‚‹ API ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã¾ã™ã€‚

```json
{
  "user": {
    "name": "Alice",
    "posts": [
      {
        "id": 1,
        "title": "Hello",
        "comments": [
          {
            "id": 1,
            "content": "Nice to meet you!"
          }
        ]
      }
    ]
  }
}
```

ãƒ¢ãƒ‡ãƒ«æ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```ruby
# Table name: users
#
#  id         :integer          not null, primary key
#  name       :string           not null
class User < ApplicationRecord
  has_many :posts
end

# Table name: posts
#
#  id         :integer          not null, primary key
#  title      :string           not null
class Post < ApplicationRecord
  belongs_to :user
  has_many :comments
end

# Table name: comments
#
#  id         :integer          not null, primary key
#  contents   :string           not null
class Comment < ApplicationRecord
  belongs_to :post
end
```

## Serializer ã®å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆ

Active Model Serializer ã§ã¯ãƒ¢ãƒ‡ãƒ«ã¨åŒã˜ã‚ˆã†ã« `has_many` ãªã©ã‚’ä½¿ã£ã¦é–¢é€£ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
å¾“ã£ã¦ä»Šå›ä½œæˆã™ã‚‹ Serializer ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ruby
class UserSerializer < ActiveModel::Serializer
  type :user

  attributes :name
  has_many :posts, serializer: PostSerializer
end

class PostSerializer < ActiveModel::Serializer
  attributes :id, :title
  has_many :comments, serializer: CommentSerializer
end

class CommentSerializer < ActiveModel::Serializer
  attributes :id, :content
end
```

ä¸Šè¨˜ã® Serializer ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚
æ™®æ®µã¯ Serializer æ¯ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€ã¾ãš `CommentSerializer` ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚

â€» æœŸå¾…ã™ã‚‹ JSON ã¨ãªã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€ `rspec-json_matcher` gem ã® `be_json_as` ã¨ã„ã†ãƒãƒƒãƒãƒ£ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™
https://github.com/r7kamura/rspec-json_matcher

```ruby
RSpec.describe CommentSerializer, type: :serializer do
  subject(:serializer) { described_class.new(comment) }

  let(:comment) { create(:comment, content: 'content') }

  it 'includes attributes as json format' do
    expect(serializer.to_json).to be_json_as(
      {
        id: comment.id,
        content: 'content'
      }
    )
  end
end
```

æ¬¡ã« `PostSerializer` ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚
ã“ã“ã§ `CommentSerializer` ã®ãƒ†ã‚¹ãƒˆã¯æ—¢ã«æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€`comments` ã«é–¢ã—ã¦ã¯ `CommentSerializer` ã‚’ä½¿ç”¨ã—ã¦æœŸå¾…ã™ã‚‹ JSON ãŒè¿”å´ã•ã‚Œã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```ruby
RSpec.describe PostSerializer, type: :serializer do
  subject(:serializer) { described_class.new(post) }

  let(:post) { create(:post, title: 'title') }
  let!(:first_comment) { create(:comment, post:) }
  let!(:second_comment) { create(:comment, post:) }

  it 'includes attributes as json format' do
    expect(serializer.to_json).to be_json_as(
      {
        id: post.id,
        title: 'title',
        comments: [
          CommentSerializer.new(first_comment).as_json,
          CommentSerializer.new(second_comment).as_json
        ]
      }
    )
  end
end
```

æœ€å¾Œã« `UserSerializer` ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚
ã“ã¡ã‚‰ã‚‚åŒæ§˜ã« `PostSerializer` ã‚’ä½¿ç”¨ã—ã¦æœŸå¾…ã™ã‚‹ JSON ãŒè¿”å´ã•ã‚Œã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```ruby
RSpec.describe UserSerializer, type: :serializer do
  subject(:serializer) { described_class.new(user) }

  let(:user) { create(:user, name: 'name') }
  let(:first_post) { create(:post, user:) }
  let(:second_post) { create(:post, user:) }

  before do
    create_list(:comment, 2, post: first_post)
    create_list(:comment, 2, post: second_post)
  end

  it 'includes attributes as json format' do
    expect(serializer.to_json).to be_json_as(
      {
        name: 'name',
        posts: [
          PostSerializer.new(first_post).as_json,
          PostSerializer.new(second_post).as_json
        ]
      }
    )
  end
end
```

ã—ã‹ã—ã“ã®ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã—ã¾ã™ã€‚
å¤±æ•—ã—ãŸåŸå› ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« `comments` ãŒç„¡ã„ãŸã‚ã§ã™ã€‚
```
actual:
{
  "name"  => "name",
  "posts" => [
    [0] {
      "id"    => 7,
      "title" => "title"
    },
    [1] {
      "id"    => 8,
      "title" => "title"
    }
  ]
}

reason: posts.[0].[
    [0] "comments"
]
```

ã“ã‚Œã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„ãŸã‚ã§ã™ã€‚
å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ `include` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
https://github.com/rails-api/active_model_serializers/blob/0-10-stable/docs/general/adapters.md#include-option

å¾“ã£ã¦ `.to_json` ã§ `include` ã‚’æŒ‡å®šã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ruby
  it 'includes attributes as json format' do
    # .to_json ã§ include ã‚’æŒ‡å®šã™ã‚‹
    expect(serializer.to_json(include: { posts: :comments })).to be_json_as(
      {
        name: 'name',
        posts: [
          PostSerializer.new(first_post).as_json,
          PostSerializer.new(second_post).as_json
        ]
      }
    )
  end
```

ã‚ã¨ã¯ Controller ã¨ãã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚Œã°å®Œæˆã§ã™ã€‚

## Controller ã®å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆ

ä¸»é¡Œã¯å…ˆã»ã©ã® Serializer ã ã£ãŸã®ã§ã€Controller ã¯ç°¡å˜ã«å®Ÿè£…ã—ã¾ã™ã€‚

```ruby
class UsersController < ApplicationController
  def show
    user = User.find(params[:id])

    render status: :ok,
           json: user, 
           serializer: UserSerializer, 
           include: { posts: :comments }, # ã“ã“ã§ã‚‚ include ã‚’æŒ‡å®šã™ã‚‹
           adapter: :json
  end
end
```
â€» ã“ã®ã¾ã¾ã§ã¯ N+1 å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ãŸã‚ `includes` ãŒå¿…è¦ã§ã™ãŒã€ä»Šå›ã¯ Serializer ã® `include` ã¨æ··åŒã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚çœç•¥ã—ã¦ã„ã¾ã™ã€‚


Controller ã®ãƒ†ã‚¹ãƒˆï¼ˆRequest Specï¼‰ã‚‚æ›¸ã„ã¦ã¿ã¾ã™ã€‚
Serializer ã®ãƒ†ã‚¹ãƒˆã¯æ—¢ã«æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€æœŸå¾…ã™ã‚‹ JSON ã‚’ä½œæˆã™ã‚‹éš›ã«ã¯ Serializer ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```ruby
RSpec.describe 'GET /users/:id' do
  subject(:api_request) { get users_path(id) }

  let(:user) { create(:user) }
  let(:id) { user.id }

  before do
    create_list(:post, 2, user:)
    create_list(:comment, 2, post: user.posts.first)
    create_list(:comment, 2, post: user.posts.last)
  end

  it 'returns a response as json format' do
    api_request
    expect(response.body).to eq(
      {
        user: UserSerializer.new(user)
      }.to_json(include: { posts: :comments }) # ã“ã“ã§ã‚‚ include ã‚’æŒ‡å®šã™ã‚‹
    )
  end
end
```


## ã¾ã¨ã‚

ä»Šå›ã¯ Active Model Serializer ã‚’ä½¿ç”¨ã—ã¦å­«è¦ç´ ã‚’å«ã‚€ JSON ã‚’è¿”å´ã™ã‚‹ API ã®å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
å­«è¦ç´ ã‚’å«ã‚€å ´åˆã¯ `include` ãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€å®Ÿè£…ã‚„ãƒ†ã‚¹ãƒˆã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

ä¸€æ–¹ã§ Active Model Serializer ã¯ã—ã°ã‚‰ãé–‹ç™ºãŒæ­¢ã¾ã£ã¦ã„ã‚‹ã®ã§ã€ä»–ã® gem ã«ç§»è¡Œã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
